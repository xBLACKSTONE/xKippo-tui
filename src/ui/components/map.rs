use ratatui::{
    buffer::Buffer,
    layout::Rect,
    style::{Color, Style},
    widgets::Widget,
};

/// World map dimensions
const MAP_WIDTH: usize = 180;
const MAP_HEIGHT: usize = 90;

/// ASCII world map (this would be loaded from a data file in a real implementation)
static WORLD_MAP: &str = "                                                                                                                                                                                                      
                                                                                                                                                                                                      
                                                                                                                                                                                                      
                                                                                                                                                                                                      
                                                     ....                 .....                                                                                                                      
                                                  ..........           ...........                                                                                                                   
                                                .............        ................                                                                                                                
                                               ...............     ...................                                                                                                               
                                              .................................................................                                                                                      
                                             ...................................................................                                                                                     
                                             ....................................................................                                                                                    
                                            .....................................................................        ......                                                                      
                                           .......................................................................    ...........                                                                    
                                          .........................................................................................                                                                   
                                          .........................................................................................                                                                   
                                         ...........................................................................................                                                                  
                                        ...........................................................   ..............................                                                                 
                                       ............................................................      ...........................                                                                
                                       ............................................................        .........................                                                                
                                      ..............................................................       ..........................                                                               
                                      .......................................................................   ........................                                                             
                                     .........................................................................     ........................                                                           
                                     .........................................................................        ....................                                                           
                                    .............................................................................       .................                                                           
                                   .................................................................................      ................                                                          
                                  ....................................................................................      ...............                                                         
                                  .....................................................................................      ..............                                                        
                                 .......................................................................................      .............                                                       
                                ........................................................................................        ............                                                       
                                .........................................................................................        ...........                                                      
                               ...........................................................................................        ..........                                                     
                               ............................................................................................       ..........                                                    
                              ..............................................................................................        .........                                                   
                             .................................................................................................       ........                                                  
                            ....................................................................................................      .......                                                 
                           ......................................................................................................      ......                                                
                          .........................................................................................................     .....                                               
                         ...........................................................................................................    ....                                               
                         ...........................................................................................................     ...                                              
                        ...............................................................................................................     .                                              
                        .................................................................................................................                                               
                       ..................................................................................................................                                              
                       ...................................................................................................................                                             
                      .....................................................................................................................                                            
                      ......................................................................................................................                                           
                     ........................................................................................................................                                          
                     .........................................................................................................................                                         
                    ...........................................................................................................................                                        
                    ............................................................................................................................                                       
                   ................................................................................................................................                                      
                  ..................................................................................................................................                                     
                  ...................................................................................................................................                                    
                 .....................................................................................................................................                                   
                .......................................................................................................................................                                  
                ........................................................................................................................................                                 
               ..........................................................................................................................................                                
               ...........................................................................................................................................                               
              .............................................................................................................................................                              
              ..............................................................................................................................................                             
             ................................................................................................................................................                            
             .................................................................................................................................................                           
            ...................................................................................................................................................                          
            ....................................................................................................................................................                         
           ......................................................................................................................................................                        
           .......................................................................................................................................................                       
          .........................................................................................................................................................                      
         ...........................................................................................................................................................                     
         ............................................................................................................................................................                    
        ..............................................................................................................................................................                   
        ...............................................................................................................................................................                  
       .................................................................................................................................................................                 
       ..................................................................................................................................................................                
      ....................................................................................................................................................................               
      .....................................................................................................................................................................              
     .......................................................................................................................................................................             
     ........................................................................................................................................................................            
    ..........................................................................................................................................................................           
    ...........................................................................................................................................................................          
   .............................................................................................................................................................................         
   ..............................................................................................................................................................................        
  ................................................................................................................................................................................       
 ..................................................................................................................................................................................      
 ...................................................................................................................................................................................     
.....................................................................................................................................................................................    
......................................................................................................................................................................................   
...................................................................................................................................................................................................................................  
....................................................................................................................................................................................................................................";

/// WorldMap widget for displaying a world map with attack points
pub struct WorldMap {
    /// Attack points (latitude, longitude, intensity)
    attack_points: Vec<(f64, f64, u8)>,
    /// Map style
    style: Style,
}

impl WorldMap {
    /// Create a new world map
    pub fn new(attack_points: Vec<(f64, f64, u8)>) -> Self {
        Self {
            attack_points,
            style: Style::default().fg(Color::Blue),
        }
    }
    
    /// Set the map style
    pub fn style(mut self, style: Style) -> Self {
        self.style = style;
        self
    }
    
    /// Convert latitude and longitude to map coordinates
    fn convert_coords(&self, lat: f64, lon: f64, width: u16, height: u16) -> Option<(u16, u16)> {
        // Normalize the coordinates to fit within the map
        let x = ((lon + 180.0) / 360.0) * width as f64;
        let y = ((90.0 - lat) / 180.0) * height as f64;
        
        if x >= 0.0 && x < width as f64 && y >= 0.0 && y < height as f64 {
            Some((x as u16, y as u16))
        } else {
            None
        }
    }
}

impl Widget for WorldMap {
    fn render(self, area: Rect, buf: &mut Buffer) {
        if area.width < 10 || area.height < 5 {
            return; // Area too small to render map
        }
        
        // Draw the base map
        let lines: Vec<&str> = WORLD_MAP.lines().collect();
        let map_height = lines.len();
        
        for (y, line) in lines.iter().enumerate() {
            if y >= area.height as usize {
                break;
            }
            
            let map_line = line.chars().collect::<Vec<_>>();
            for (x, &ch) in map_line.iter().enumerate().take(area.width as usize) {
                if ch != ' ' {
                    buf.get_mut(area.x + x as u16, area.y + y as u16)
                        .set_char(ch)
                        .set_style(self.style);
                }
            }
        }
        
        // Draw attack points
        for &(lat, lon, intensity) in &self.attack_points {
            if let Some((x, y)) = self.convert_coords(lat, lon, area.width, area.height) {
                let color = match intensity {
                    0..=3 => Color::Yellow,
                    4..=7 => Color::LightRed,
                    _ => Color::Red,
                };
                
                let char_to_draw = match intensity {
                    0..=3 => '•',
                    4..=7 => '◘',
                    _ => '■',
                };
                
                buf.get_mut(area.x + x, area.y + y)
                    .set_char(char_to_draw)
                    .set_style(Style::default().fg(color));
            }
        }
    }
}